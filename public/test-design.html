<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEARS - Swap on Base</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Background Effects */
        .bg-effect {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(254, 116, 91, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            top: 10%;
            right: 5%;
            animation: float 8s ease-in-out infinite;
        }

        .bg-effect-2 {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(254, 116, 91, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            bottom: 20%;
            left: 10%;
            animation: float 12s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 40px;
            position: relative;
            z-index: 10;
        }

        .logo {
            height: 120px;
            width: auto;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-top: 20px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .nav-link:hover, .nav-link.active {
            color: #FE745B;
            background: rgba(254, 116, 91, 0.1);
        }

        .connect-wallet {
            background: linear-gradient(45deg, #FE745B, #FF8A6B);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-wallet.not-connected {
            animation: subtleGlow 3s ease-in-out infinite;
        }

        @keyframes subtleGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(254, 116, 91, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(254, 116, 91, 0.5);
            }
        }

        .connect-wallet:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(254, 116, 91, 0.4);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            position: relative;
        }

        /* Swap Container */
        .swap-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(254, 116, 91, 0.2);
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 480px;
            position: relative;
        }

        .swap-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .swap-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(45deg, #FE745B, #FF8A6B);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .swap-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
        }

        /* Token Input */
        .token-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
        }

        .token-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .token-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
        }

        .token-balance {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        .token-input-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            padding-right: 0px;
        }

        .amount-input {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            font-weight: 600;
            flex: 1;
            outline: none;
            min-width: 0;
        }

        .amount-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .token-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            color: white;
            font-weight: 500;
            flex-shrink: 0;
        }

        .token-selector:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .token-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FE745B;
            object-fit: cover;
        }

        /* Switch Button */
        .switch-container {
            display: flex;
            justify-content: center;
            margin: 8px 0;
            position: relative;
        }

        .switch-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(254, 116, 91, 0.3);
            border-radius: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 18px;
        }

        .switch-button:hover {
            border-color: #FE745B;
            background: rgba(254, 116, 91, 0.1);
            transform: rotate(180deg);
        }

        /* Swap Button */
        .swap-button {
            width: 100%;
            background: linear-gradient(45deg, #FE745B, #FF8A6B);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        .swap-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(254, 116, 91, 0.4);
        }

        .swap-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Status Message */
        .status-message {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 14px;
            display: none;
            position: relative;
        }

        .status-message.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .status-message.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .status-message a {
            color: #FE745B;
            text-decoration: none;
            font-weight: 500;
        }

        .status-message a:hover {
            text-decoration: underline;
        }

        .close-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: currentColor;
            opacity: 0.6;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
        }

        .close-status:hover {
            opacity: 1;
        }

        /* Token Modal */
        .token-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .token-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(254, 116, 91, 0.2);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 500px;
        }

        .token-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .token-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .token-search {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
        }

        .token-search::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .token-list {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .token-list::-webkit-scrollbar {
            display: none;
        }

        .token-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .token-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .token-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #FE745B;
            object-fit: cover;
        }

        .token-item-info {
            flex: 1;
        }

        .token-item-symbol {
            font-weight: 600;
            color: white;
            font-size: 16px;
        }

        .token-item-name {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }

            .logo {
                height: 60px;
            }

            .header-right {
                gap: 16px;
            }

            .nav-link {
                font-size: 14px;
                padding: 6px 12px;
            }

            .connect-wallet {
                padding: 10px 20px;
                font-size: 14px;
            }

            .main-content {
                padding: 20px 16px;
            }

            .swap-container {
                padding: 24px;
            }

            .swap-title {
                font-size: 24px;
            }

            .amount-input {
                font-size: 20px;
            }

            .token-modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Background Effects -->
        <div class="bg-effect"></div>
        <div class="bg-effect-2"></div>

        <!-- Header -->
        <div class="header">
            <img src="Logo Pears.png" alt="PEARS" class="logo">
            <div class="header-right">
                <a href="/test-design" class="nav-link active">Swap</a>
                <a href="/roadmap" class="nav-link">Roadmap</a>
                <button class="connect-wallet not-connected" id="connectWallet">Connect Base Wallet</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="swap-container">
                <div class="swap-header">
                    <h1 class="swap-title">Swap on Base</h1>
                    <p class="swap-subtitle">Lightning fast â€¢ 0.08% fees â€¢ MEV protected</p>
                </div>

                <!-- From Token -->
                <div class="token-input">
                    <div class="token-input-header">
                        <span class="token-label">From</span>
                        <span class="token-balance" id="fromBalance">Balance: 0</span>
                    </div>
                    <div class="token-input-main">
                        <input type="text" class="amount-input" id="fromAmount" placeholder="0">
                        <button class="token-selector" id="fromTokenSelector">
                            <img class="token-icon" id="fromTokenIcon" src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png" alt="ETH">
                            <span id="fromTokenSymbol">ETH</span>
                            <span>â–¼</span>
                        </button>
                    </div>
                </div>

                <!-- Switch Button -->
                <div class="switch-container">
                    <button class="switch-button" id="switchTokens">â‡…</button>
                </div>

                <!-- To Token -->
                <div class="token-input">
                    <div class="token-input-header">
                        <span class="token-label">To</span>
                        <span class="token-balance" id="toBalance">Balance: 0</span>
                    </div>
                    <div class="token-input-main">
                        <input type="text" class="amount-input" id="toAmount" placeholder="0" readonly>
                        <button class="token-selector" id="toTokenSelector">
                            <img class="token-icon" id="toTokenIcon" src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png" alt="USDC">
                            <span id="toTokenSymbol">USDC</span>
                            <span>â–¼</span>
                        </button>
                    </div>
                </div>

                <!-- Swap Button -->
                <button class="swap-button" id="swapButton" disabled>Connect Wallet</button>

                <!-- Status Message -->
                <div class="status-message" id="statusMessage"></div>
            </div>
        </div>

        <!-- Token Selection Modal -->
        <div class="token-modal" id="tokenModal">
            <div class="token-modal-content">
                <div class="token-modal-header">
                    <span class="token-modal-title">Select Token</span>
                    <button class="close-modal" id="closeModal">Ã—</button>
                </div>
                <input type="text" class="token-search" id="tokenSearch" placeholder="Search tokens or paste address">
                <div class="token-list" id="tokenList"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let provider = null;
        let signer = null;
        let userAddress = null;
        let currentTokenSelection = null; // 'from' or 'to'

        // Base network configuration
        const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
        const BASE_RPC_URL = 'https://mainnet.base.org';

        // Token list for Base network with icons
        const BASE_TOKENS = [
            {
                symbol: 'ETH',
                name: 'Ethereum',
                address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                decimals: 18,
                icon: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png'
            },
            {
                symbol: 'USDC',
                name: 'USD Coin',
                address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
                decimals: 6,
                icon: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png'
            },
            {
                symbol: 'WETH',
                name: 'Wrapped Ethereum',
                address: '0x4200000000000000000000000000000000000006',
                decimals: 18,
                icon: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png'
            },
            {
                symbol: 'DAI',
                name: 'Dai Stablecoin',
                address: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb',
                decimals: 18,
                icon: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x6B175474E89094C44Da98b954EedeAC495271d0F/logo.png'
            }
        ];

        // Function to get token icon with fallback
        function getTokenIcon(address) {
            // Try multiple sources
            const token = BASE_TOKENS.find(t => t.address.toLowerCase() === address.toLowerCase());
            if (token?.icon) return token.icon;

            // Fallback to blockchain explorers or token lists
            // For Base chain tokens, we can use various sources
            return `https://raw.githubusercontent.com/base-org/brand-kit/main/logo/symbol/Base_Symbol_Blue.png`;
        }

        // Current token selection
        let fromToken = BASE_TOKENS[0]; // ETH
        let toToken = BASE_TOKENS[1]; // USDC

        // Connect wallet functionality
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('Please install MetaMask!', 'error');
                    return;
                }

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                // Switch to Base network
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: [BASE_RPC_URL],
                                blockExplorerUrls: ['https://basescan.org/']
                            }]
                        });
                    }
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                const walletButton = document.getElementById('connectWallet');
                walletButton.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                walletButton.classList.remove('not-connected');
                document.getElementById('swapButton').textContent = 'Enter Amount';
                document.getElementById('swapButton').disabled = false;

                await updateBalances();
                showStatus('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus('Failed to connect wallet', 'error');
            }
        }

        // Update token balances
        async function updateBalances() {
            if (!provider || !userAddress) return;

            try {
                // Update from token balance
                const fromBalance = await getTokenBalance(fromToken.address, userAddress);
                document.getElementById('fromBalance').textContent = `Balance: ${fromBalance}`;

                // Update to token balance
                const toBalance = await getTokenBalance(toToken.address, userAddress);
                document.getElementById('toBalance').textContent = `Balance: ${toBalance}`;
            } catch (error) {
                console.error('Error updating balances:', error);
            }
        }

        // Get token balance
        async function getTokenBalance(tokenAddress, userAddress) {
            if (tokenAddress === '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE') {
                // ETH balance
                const balance = await provider.getBalance(userAddress);
                return parseFloat(ethers.formatEther(balance)).toFixed(4);
            } else {
                // ERC20 token balance
                const contract = new ethers.Contract(tokenAddress, [
                    'function balanceOf(address) view returns (uint256)',
                    'function decimals() view returns (uint8)'
                ], provider);

                const balance = await contract.balanceOf(userAddress);
                const decimals = await contract.decimals();
                return parseFloat(ethers.formatUnits(balance, decimals)).toFixed(4);
            }
        }

        // Token selection modal
        function openTokenModal(type) {
            currentTokenSelection = type;
            const modal = document.getElementById('tokenModal');
            const tokenList = document.getElementById('tokenList');

            // Clear and populate token list
            tokenList.innerHTML = '';
            BASE_TOKENS.forEach(token => {
                const tokenItem = document.createElement('div');
                tokenItem.className = 'token-item';
                tokenItem.innerHTML = `
                    <img class="token-item-icon" src="${token.icon}" alt="${token.symbol}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNiIgZmlsbD0iI0ZFNzQ1QiIvPjx0ZXh0IHg9IjE2IiB5PSIyMSIgZm9udC1mYW1pbHk9IkludGVyIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+JHt0b2tlbi5zeW1ib2wuc2xpY2UoMCwgMil9PC90ZXh0Pjwvc3ZnPg=='">
                    <div class="token-item-info">
                        <div class="token-item-symbol">${token.symbol}</div>
                        <div class="token-item-name">${token.name}</div>
                    </div>
                `;
                tokenItem.onclick = () => selectToken(token);
                tokenList.appendChild(tokenItem);
            });

            modal.style.display = 'block';
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').style.display = 'none';
        }

        function selectToken(token) {
            if (currentTokenSelection === 'from') {
                fromToken = token;
                document.getElementById('fromTokenSymbol').textContent = token.symbol;
                document.getElementById('fromTokenIcon').src = token.icon;
                document.getElementById('fromTokenIcon').alt = token.symbol;
            } else {
                toToken = token;
                document.getElementById('toTokenSymbol').textContent = token.symbol;
                document.getElementById('toTokenIcon').src = token.icon;
                document.getElementById('toTokenIcon').alt = token.symbol;
            }

            closeTokenModal();
            updateBalances();

            // Get new quote if there's an amount
            const fromAmount = document.getElementById('fromAmount').value;
            if (fromAmount && parseFloat(fromAmount) > 0) {
                getQuote();
            }
        }

        // Switch tokens
        function switchTokens() {
            const tempToken = fromToken;
            fromToken = toToken;
            toToken = tempToken;

            document.getElementById('fromTokenSymbol').textContent = fromToken.symbol;
            document.getElementById('toTokenSymbol').textContent = toToken.symbol;
            document.getElementById('fromTokenIcon').src = fromToken.icon;
            document.getElementById('toTokenIcon').src = toToken.icon;
            document.getElementById('fromTokenIcon').alt = fromToken.symbol;
            document.getElementById('toTokenIcon').alt = toToken.symbol;

            // Swap the amounts too
            const fromAmount = document.getElementById('fromAmount').value;
            const toAmount = document.getElementById('toAmount').value;
            document.getElementById('fromAmount').value = toAmount;
            document.getElementById('toAmount').value = fromAmount;

            updateBalances();

            // Get new quote if there's an amount
            if (document.getElementById('fromAmount').value) {
                getQuote();
            }
        }

        // Show status message with optional close button
        function showStatus(message, type, persistent = false) {
            const statusElement = document.getElementById('statusMessage');

            // Add close button for success messages
            if (type === 'success' && persistent) {
                statusElement.innerHTML = `
                    ${message}
                    <button class="close-status" onclick="closeStatus()">Ã—</button>
                `;
            } else {
                statusElement.innerHTML = message;
            }

            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';

            // Auto-hide non-persistent messages
            if (!persistent) {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

        // Close status message
        function closeStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        // Get quote for swap
        let quoteTimeout = null;
        async function getQuote() {
            const fromAmount = document.getElementById('fromAmount').value;

            if (!fromAmount || parseFloat(fromAmount) <= 0) {
                document.getElementById('toAmount').value = '';
                return;
            }

            try {
                // Convert amount to smallest unit
                const sellAmount = ethers.parseUnits(fromAmount, fromToken.decimals).toString();

                // Use V3 quote endpoint
                const response = await fetch('/api/v3-quote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sellToken: fromToken.address,
                        buyToken: toToken.address,
                        sellAmount: sellAmount,
                        taker: userAddress || '0x0000000000000000000000000000000000000000'
                    })
                });

                const quote = await response.json();

                if (quote.buyAmount) {
                    const buyAmount = ethers.formatUnits(quote.buyAmount, toToken.decimals);
                    document.getElementById('toAmount').value = parseFloat(buyAmount).toFixed(6);
                }
            } catch (error) {
                console.error('Error getting quote:', error);
            }
        }

        // Execute real swap using V3 API
        async function executeSwap() {
            if (!signer || !userAddress) {
                showStatus('Please connect wallet first', 'error');
                await connectWallet();
                return;
            }

            const fromAmount = document.getElementById('fromAmount').value;
            if (!fromAmount || parseFloat(fromAmount) <= 0) {
                showStatus('Please enter a valid amount', 'error');
                return;
            }

            const btn = document.getElementById('swapButton');

            try {
                // Step 1: Get fresh quote
                btn.textContent = 'Getting Quote...';
                btn.disabled = true;
                showStatus('ðŸ”„ Getting fresh quote...', 'info');

                const sellAmount = ethers.parseUnits(fromAmount, fromToken.decimals).toString();

                const response = await fetch('/api/v3-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sellToken: fromToken.address,
                        buyToken: toToken.address,
                        sellAmount: sellAmount,
                        taker: userAddress
                    })
                });

                if (!response.ok) throw new Error('Failed to get quote');
                const swapData = await response.json();

                const buyAmount = ethers.formatUnits(swapData.buyAmount, toToken.decimals);
                console.log(`âœ… Quote: ${fromAmount} ${fromToken.symbol} â†’ ${buyAmount} ${toToken.symbol}`);

                // Step 2: Check if we need token approval
                if (fromToken.address !== '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE' && swapData.issues?.allowance) {
                    // Need approval
                    btn.textContent = 'Approve token...';
                    showStatus('ðŸ“± Please approve token spending in MetaMask', 'info');

                    // Get the allowance target from swap data
                    const spender = swapData.issues.allowance.spender;

                    // Create approval transaction
                    const tokenContract = new ethers.Contract(
                        fromToken.address,
                        ['function approve(address spender, uint256 amount) returns (bool)'],
                        signer
                    );

                    const approveTx = await tokenContract.approve(
                        spender,
                        ethers.MaxUint256 // Approve max amount
                    );

                    btn.textContent = 'Approving...';
                    showStatus('â³ Approving token...', 'info');
                    await approveTx.wait();

                    // Get fresh quote after approval
                    btn.textContent = 'Getting new quote...';
                    const retryResponse = await fetch('/api/v3-quote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sellToken: fromToken.address,
                            buyToken: toToken.address,
                            sellAmount: sellAmount,
                            taker: userAddress
                        })
                    });

                    if (!retryResponse.ok) throw new Error('Failed to get quote after approval');
                    swapData = await retryResponse.json();
                }

                // Step 3: Execute transaction
                btn.textContent = 'Confirming swap...';
                showStatus('ðŸ“± Please confirm the swap in MetaMask', 'info');

                const txParams = {
                    to: swapData.to,
                    data: swapData.data,
                    value: BigInt(swapData.value || '0')
                };

                // Estimate gas
                const gasEstimate = await provider.estimateGas({
                    ...txParams,
                    from: userAddress
                });

                // Send transaction
                btn.textContent = 'Processing...';
                const tx = await signer.sendTransaction({
                    ...txParams,
                    gasLimit: gasEstimate
                });

                showStatus('â³ Swap processing...', 'info');

                // Wait for confirmation
                btn.textContent = 'Finalizing...';
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    showStatus(
                        `âœ… Swap successful! <a href="https://basescan.org/tx/${tx.hash}" target="_blank">View transaction</a>`,
                        'success',
                        true // Make it persistent with close button
                    );
                    // Clear inputs and update balances
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                    await updateBalances();
                } else {
                    throw new Error('Transaction failed');
                }

                btn.textContent = 'Swap';
                btn.disabled = false;

            } catch (error) {
                console.error('Swap error:', error);
                let errorMsg = 'Swap failed. ';

                if (error.message?.includes('insufficient funds')) {
                    errorMsg = 'Insufficient balance for this swap';
                } else if (error.message?.includes('user rejected') || error.message?.includes('User denied')) {
                    errorMsg = 'Transaction cancelled';
                } else if (error.message?.includes('allowance')) {
                    errorMsg = 'Please try again - approval may be needed';
                } else {
                    errorMsg += error.message?.substring(0, 50) || 'Please try again';
                }

                showStatus(errorMsg, 'error');
                btn.textContent = 'Swap';
                btn.disabled = false;
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('fromTokenSelector').addEventListener('click', () => openTokenModal('from'));
        document.getElementById('toTokenSelector').addEventListener('click', () => openTokenModal('to'));
        document.getElementById('switchTokens').addEventListener('click', switchTokens);
        document.getElementById('swapButton').addEventListener('click', executeSwap);
        document.getElementById('closeModal').addEventListener('click', closeTokenModal);

        // Close modal when clicking outside
        document.getElementById('tokenModal').addEventListener('click', (e) => {
            if (e.target.id === 'tokenModal') {
                closeTokenModal();
            }
        });

        // Amount input handler with debounced quote
        document.getElementById('fromAmount').addEventListener('input', (e) => {
            const amount = e.target.value;

            // Update button state
            if (amount && parseFloat(amount) > 0) {
                document.getElementById('swapButton').textContent = 'Swap';
                document.getElementById('swapButton').disabled = false;

                // Debounce quote fetching to avoid too many API calls
                clearTimeout(quoteTimeout);
                quoteTimeout = setTimeout(() => {
                    getQuote();
                }, 500);
            } else {
                document.getElementById('swapButton').textContent = userAddress ? 'Enter Amount' : 'Connect Wallet';
                document.getElementById('swapButton').disabled = !userAddress;
                document.getElementById('toAmount').value = '';
            }
        });
    </script>
</body>
</html>