<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEARS Swap - Next Generation DEX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- DNS Prefetch for 0x API -->
    <link rel="dns-prefetch" href="https://api.0x.org">

    <!-- Ethers.js for Web3 functionality -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            position: relative;
            z-index: 10;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .roadmap-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .roadmap-link:hover {
            color: #FE745B;
            background: rgba(254, 116, 91, 0.1);
        }

        .logo {
            height: 60px;
            width: auto;
        }

        .connect-wallet {
            background: linear-gradient(45deg, #FE745B, #FF8A6B);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connect-wallet:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(254, 116, 91, 0.3);
        }

        .connect-wallet:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Background Effects */
        .bg-effect {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(254, 116, 91, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            top: 20%;
            right: 10%;
            animation: float 6s ease-in-out infinite;
        }

        .bg-effect-2 {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(254, 116, 91, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            bottom: 20%;
            left: 10%;
            animation: float 8s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
        }

        .base-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 101, 255, 0.1);
            border: 1px solid rgba(0, 101, 255, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #0065FF;
            margin-bottom: 16px;
        }

        .base-logo {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0065FF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .title {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(45deg, #FE745B, #FF8A6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 50px;
            text-align: center;
        }

        /* Swap Container */
        .swap-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(254, 116, 91, 0.2);
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 480px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* Token Input */
        .token-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .token-input:hover {
            border-color: rgba(254, 116, 91, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }

        .token-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .token-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .balance {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .balance:hover {
            color: #FE745B;
        }

        .token-input-main {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .amount-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-align: right;
            min-height: 40px;
        }

        .amount-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .token-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .token-selector:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(254, 116, 91, 0.3);
        }

        .token-selector span {
            font-weight: 600;
            color: white;
        }

        /* Swap Direction Button */
        .swap-direction {
            display: flex;
            justify-content: center;
            margin: 8px 0;
        }

        .swap-btn-flip {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(254, 116, 91, 0.3);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #FE745B;
            font-size: 20px;
        }

        .swap-btn-flip:hover {
            transform: rotate(180deg);
            background: rgba(254, 116, 91, 0.1);
            border-color: #FE745B;
        }

        /* Swap Button */
        .swap-button {
            width: 100%;
            background: linear-gradient(45deg, #FE745B, #FF8A6B);
            border: none;
            border-radius: 16px;
            padding: 18px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        .swap-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(254, 116, 91, 0.4);
        }

        .swap-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .swap-button.sending {
            background: linear-gradient(45deg, #059669, #10B981);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Token Modal */
        .token-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .token-modal.show {
            display: flex;
        }

        .token-modal-content {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(254, 116, 91, 0.2);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 600px;
            overflow: hidden;
        }

        .token-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .token-modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .token-modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .token-search {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .token-search::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .token-search:focus {
            outline: none;
            border-color: #FE745B;
        }

        .token-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .token-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .token-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .token-option:last-child {
            border-bottom: none;
        }

        .token-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .token-symbol {
            font-weight: 600;
            color: white;
        }

        .token-name {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .custom-token {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .custom-token input {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: white;
        }

        .add-token-btn {
            padding: 8px 12px;
            font-size: 12px;
            background: #059669;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        /* Status Messages */
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .status.show { display: block; }
        .status.success { background: #065f46; border: 1px solid #10B981; }
        .status.error { background: #7f1d1d; border: 1px solid #EF4444; }
        .status.loading { background: #1e3a8a; border: 1px solid #3B82F6; }
        .status.warning { background: #854d0e; border: 1px solid #F59E0B; }

        .metamask-helper {
            background: #1e3a8a;
            border: 1px solid #3B82F6;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .metamask-helper.show { display: block; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }

            .main-content {
                padding: 20px;
            }

            .swap-container {
                padding: 24px;
            }

            .title {
                font-size: 36px;
            }

            .amount-input {
                font-size: 20px;
            }

            .token-modal-content {
                width: 95%;
                margin: 20px;
            }

            .logo {
                height: 50px;
            }

            .header-right {
                gap: 16px;
            }

            .connect-wallet {
                padding: 10px 16px;
                font-size: 14px;
            }

            .roadmap-link {
                font-size: 14px;
                padding: 6px 12px;
            }
        }

        @media (max-width: 480px) {
            .token-input-main {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .amount-input {
                text-align: left;
                font-size: 18px;
            }

            .token-selector {
                min-width: auto;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Background Effects -->
        <div class="bg-effect"></div>
        <div class="bg-effect-2"></div>

        <!-- Header -->
        <div class="header">
            <img src="Logo Pears.png" alt="PEARS" class="logo">
            <div class="header-right">
                <a href="/roadmap" class="roadmap-link">Roadmap</a>
                <button id="connectBtn" class="connect-wallet" onclick="connectWallet()">
                    <span>🔗</span>
                    <span>Connect Base Wallet</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Base Network Indicator -->
            <div class="base-indicator">
                <div class="base-logo">B</div>
                <span>Base Network Only</span>
            </div>

            <h1 class="title">🍐 PEARS Swap</h1>

            <!-- Swap Container -->
            <div class="swap-container">
                <!-- From Token -->
                <div class="token-input">
                    <div class="token-input-header">
                        <span class="token-label">From</span>
                        <span id="fromBalance" class="balance" onclick="useMaxBalance('from')"></span>
                    </div>
                    <div class="token-input-main">
                        <input
                            type="text"
                            id="fromAmount"
                            class="amount-input"
                            placeholder="0.0"
                            oninput="debounceQuote()"
                        />
                        <div id="fromTokenSelect" class="token-selector" onclick="selectFromToken()">
                            <span>ETH</span>
                            <span>▼</span>
                        </div>
                    </div>
                    <div id="fromCustomToken" class="custom-token" style="display: none;">
                        <input type="text" id="fromCustomAddress" placeholder="0x..." />
                        <button class="add-token-btn" onclick="addCustomFromToken()">Add</button>
                    </div>
                </div>

                <!-- Swap Direction -->
                <div class="swap-direction">
                    <button class="swap-btn-flip" onclick="flipTokens()">⇅</button>
                </div>

                <!-- To Token -->
                <div class="token-input">
                    <div class="token-input-header">
                        <span class="token-label">To</span>
                        <span id="toBalance" class="balance"></span>
                    </div>
                    <div class="token-input-main">
                        <input
                            type="text"
                            id="toAmount"
                            class="amount-input"
                            placeholder="0.0"
                            readonly
                        />
                        <div id="toTokenSelect" class="token-selector" onclick="selectToToken()">
                            <span>USDC</span>
                            <span>▼</span>
                        </div>
                    </div>
                    <div id="toCustomToken" class="custom-token" style="display: none;">
                        <input type="text" id="toCustomAddress" placeholder="0x..." />
                        <button class="add-token-btn" onclick="addCustomToToken()">Add</button>
                    </div>
                </div>

                <!-- Swap Button -->
                <button id="swapBtn" class="swap-button" onclick="executeSwap()" disabled>Connect Wallet</button>

                <!-- MetaMask Helper -->
                <div id="metamaskHelper" class="metamask-helper">
                    💡 Look for the MetaMask popup or click the extension icon
                </div>

                <!-- Status Messages -->
                <div id="status" class="status"></div>
            </div>
        </div>

        <!-- Token Selector Modal -->
        <div id="tokenModal" class="token-modal">
            <div class="token-modal-content">
                <div class="token-modal-header">
                    <h3 class="token-modal-title">Select Token</h3>
                    <button class="token-modal-close" onclick="closeTokenModal()">×</button>
                </div>
                <input type="text" id="tokenSearch" class="token-search" placeholder="Search by name or paste address..." oninput="filterTokens()" />
                <div id="tokenList" class="token-list"></div>
            </div>
        </div>
    </div>

    <script>
        // V3 Multi-Token Swap Interface with Beautiful UI - EXACT WORKING CODE FROM V3

        // Base ecosystem token data
        const BASE_TOKENS = {
            '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE': { symbol: 'ETH', name: 'Ethereum', decimals: 18 },
            '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913': { symbol: 'USDC', name: 'USD Coin', decimals: 6 },
            '0x4200000000000000000000000000000000000006': { symbol: 'WETH', name: 'Wrapped Ether', decimals: 18 },
            '0x2Ae3F1Ec7F1F5012CFEab0185bfc7aa3cf0DEc22': { symbol: 'cbETH', name: 'Coinbase Wrapped Staked ETH', decimals: 18 },
            '0xcbb7C0000aB88B473b1f5aFd9ef808440eed33Bf': { symbol: 'cbBTC', name: 'Coinbase Wrapped BTC', decimals: 8 },
            '0x940181a94A35A4569E4529A3CDfB74e38FD98631': { symbol: 'AERO', name: 'Aerodrome', decimals: 18 },
            '0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed': { symbol: 'DEGEN', name: 'Degen', decimals: 18 },
            '0xA219439258ca9da29E9Cc4cE5596924745e12B93': { symbol: 'ZORA', name: 'Zora', decimals: 18 }
        };

        // State
        let provider = null;
        let signer = null;
        let userAddress = null;
        let sessionTokens = { ...BASE_TOKENS }; // Session tokens include base + custom
        let quoteDebounceTimer = null;
        let currentTokenSide = null; // 'from' or 'to'

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = message; // Use innerHTML for better formatting
            status.className = `status show ${type}`;
        }

        // Show user-friendly error with optional details
        function showUserFriendlyError(friendlyMessage, technicalDetails) {
            const status = document.getElementById('status');

            status.innerHTML = `
                <div style="margin-bottom: 8px;">${friendlyMessage}</div>
                <div style="font-size: 12px; opacity: 0.8;">
                    <span id="errorToggle" style="cursor: pointer; text-decoration: underline;" onclick="toggleErrorDetails()">
                        View technical details
                    </span>
                </div>
                <div id="errorDetails" style="display: none; font-size: 11px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; word-break: break-all;">
                    ${technicalDetails}
                </div>
            `;

            status.className = 'status show error';
        }

        // Toggle error details visibility
        function toggleErrorDetails() {
            const details = document.getElementById('errorDetails');
            const toggle = document.getElementById('errorToggle');

            if (details.style.display === 'none') {
                details.style.display = 'block';
                toggle.textContent = 'Hide technical details';
            } else {
                details.style.display = 'none';
                toggle.textContent = 'View technical details';
            }
        }

        // Debounce quote updates for smooth typing
        function debounceQuote() {
            if (quoteDebounceTimer) clearTimeout(quoteDebounceTimer);
            quoteDebounceTimer = setTimeout(updateQuote, 500);
        }

        // Connect wallet - NO auto-requests
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showStatus('Please install MetaMask', 'error');
                    return;
                }

                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '<span>🔄</span><span>Connecting...</span>';
                btn.disabled = true;

                // Switch to Base
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x2105' }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x2105',
                                chainName: 'Base',
                                nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://omniscient-long-borough.base-mainnet.quiknode.pro/106c408fac18c1e8edc97692049248af9734aaef/'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                    }
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send('eth_requestAccounts', []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                btn.innerHTML = `<span>✅</span><span>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</span>`;
                document.getElementById('swapBtn').disabled = false;

                showStatus(`Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`, 'success');

                // Load balances for connected tokens
                await updateBalances();

            } catch (error) {
                showStatus('Connection failed', 'error');
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '<span>🔗</span><span>Connect Base Wallet</span>';
                btn.disabled = false;
            }
        }

        // Update balances for all tokens
        async function updateBalances() {
            if (!provider || !userAddress) return;

            const fromToken = document.getElementById('fromTokenSelect').dataset.value || '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE';
            const toToken = document.getElementById('toTokenSelect').dataset.value || '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';

            if (fromToken) {
                const balance = await getTokenBalance(fromToken);
                const symbol = sessionTokens[fromToken]?.symbol || 'TOKEN';
                document.getElementById('fromBalance').textContent = `Balance: ${balance} ${symbol} (click to use max)`;
                document.getElementById('fromBalance').dataset.balance = balance;
            }

            if (toToken) {
                const balance = await getTokenBalance(toToken);
                const symbol = sessionTokens[toToken]?.symbol || 'TOKEN';
                document.getElementById('toBalance').textContent = `Balance: ${balance} ${symbol}`;
            }
        }

        // Use max balance when clicking on balance
        function useMaxBalance(side) {
            const balanceDiv = document.getElementById(`${side}Balance`);
            const balance = balanceDiv.dataset.balance;

            if (balance && side === 'from') {
                // Leave some ETH for gas if selling ETH
                const fromToken = document.getElementById('fromTokenSelect').dataset.value || '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE';
                if (fromToken.toLowerCase() === '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee') {
                    // Keep 0.001 ETH for gas
                    const maxAmount = Math.max(0, parseFloat(balance) - 0.001);
                    document.getElementById('fromAmount').value = maxAmount.toFixed(6);
                } else {
                    document.getElementById('fromAmount').value = balance;
                }
                updateQuote();
            }
        }

        // Get token balance
        async function getTokenBalance(tokenAddress) {
            if (!provider || !userAddress) return '0';

            try {
                if (tokenAddress.toLowerCase() === '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee') {
                    // ETH balance
                    const balance = await provider.getBalance(userAddress);
                    return parseFloat(ethers.formatEther(balance)).toFixed(4);
                } else {
                    // ERC20 token balance
                    const tokenContract = new ethers.Contract(
                        tokenAddress,
                        ['function balanceOf(address) view returns (uint256)', 'function decimals() view returns (uint8)'],
                        provider
                    );
                    const balance = await tokenContract.balanceOf(userAddress);
                    const decimals = await tokenContract.decimals();
                    return parseFloat(ethers.formatUnits(balance, decimals)).toFixed(4);
                }
            } catch (error) {
                console.error('Balance fetch error:', error);
                return '0';
            }
        }

        // Handle from token selection
        function selectFromToken() {
            currentTokenSide = 'from';
            openTokenModal();
        }

        // Handle to token selection
        function selectToToken() {
            currentTokenSide = 'to';
            openTokenModal();
        }

        // Open token modal
        function openTokenModal() {
            const modal = document.getElementById('tokenModal');
            const tokenList = document.getElementById('tokenList');

            // Populate token list
            tokenList.innerHTML = '';
            Object.entries(sessionTokens).forEach(([address, token]) => {
                const tokenOption = document.createElement('div');
                tokenOption.className = 'token-option';
                tokenOption.onclick = () => selectToken(address);

                tokenOption.innerHTML = `
                    <div class="token-info">
                        <div class="token-symbol">${token.symbol}</div>
                        <div class="token-name">${token.name}</div>
                    </div>
                `;

                tokenList.appendChild(tokenOption);
            });

            modal.classList.add('show');
            document.getElementById('tokenSearch').focus();
        }

        function closeTokenModal() {
            const modal = document.getElementById('tokenModal');
            modal.classList.remove('show');
            currentTokenSide = null;
            document.getElementById('tokenSearch').value = '';
        }

        function filterTokens() {
            const searchTerm = document.getElementById('tokenSearch').value.toLowerCase();
            const tokenOptions = document.querySelectorAll('.token-option');

            tokenOptions.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });

            // Check if search term looks like an address
            if (searchTerm.startsWith('0x') && searchTerm.length >= 10) {
                // Add custom token option
                let customOption = document.getElementById('customTokenOption');
                if (!customOption) {
                    customOption = document.createElement('div');
                    customOption.id = 'customTokenOption';
                    customOption.className = 'token-option';
                    customOption.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                    customOption.onclick = () => addCustomToken(searchTerm);

                    customOption.innerHTML = `
                        <div class="token-info">
                            <div class="token-symbol">Add Custom Token</div>
                            <div class="token-name">${searchTerm}</div>
                        </div>
                    `;

                    document.getElementById('tokenList').appendChild(customOption);
                }
            } else {
                const customOption = document.getElementById('customTokenOption');
                if (customOption) customOption.remove();
            }
        }

        async function selectToken(address) {
            const token = sessionTokens[address];
            if (!token) return;

            if (currentTokenSide === 'from') {
                document.getElementById('fromTokenSelect').querySelector('span').textContent = token.symbol;
                document.getElementById('fromTokenSelect').dataset.value = address;
            } else {
                document.getElementById('toTokenSelect').querySelector('span').textContent = token.symbol;
                document.getElementById('toTokenSelect').dataset.value = address;
            }

            closeTokenModal();
            await updateBalances();
            updateQuote();
        }

        async function addCustomToken(address) {
            try {
                showStatus('Validating token...', 'loading');
                const response = await fetch(`/api/v3-token/${address}`);
                const data = await response.json();

                if (data.valid && data.tradeable) {
                    // Add to session tokens
                    sessionTokens[address] = {
                        symbol: data.symbol || 'CUSTOM',
                        name: data.name || 'Custom Token',
                        decimals: data.decimals || 18
                    };

                    showStatus('Custom token added successfully', 'success');
                    await selectToken(address);
                } else {
                    showStatus('Token not supported for trading', 'error');
                }
            } catch (error) {
                showStatus('Invalid token address', 'error');
            }
        }

        // Flip tokens
        function flipTokens() {
            const fromSelect = document.getElementById('fromTokenSelect');
            const toSelect = document.getElementById('toTokenSelect');
            const fromAmount = document.getElementById('fromAmount');
            const toAmount = document.getElementById('toAmount');

            // Swap the selected values
            const tempValue = fromSelect.dataset.value;
            const tempText = fromSelect.querySelector('span').textContent;

            fromSelect.dataset.value = toSelect.dataset.value;
            fromSelect.querySelector('span').textContent = toSelect.querySelector('span').textContent;

            toSelect.dataset.value = tempValue;
            toSelect.querySelector('span').textContent = tempText;

            // Swap amounts
            const tempAmount = fromAmount.value;
            fromAmount.value = toAmount.value;
            toAmount.value = tempAmount;

            // Update UI
            updateBalances();
            updateQuote();
        }

        // Update quote when amount changes
        async function updateQuote() {
            const fromToken = document.getElementById('fromTokenSelect').dataset.value || '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE';
            const toToken = document.getElementById('toTokenSelect').dataset.value || '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
            const fromAmount = document.getElementById('fromAmount').value;

            if (!fromToken || !toToken || !fromAmount) {
                document.getElementById('toAmount').value = '';
                return;
            }

            if (fromToken === toToken) {
                document.getElementById('toAmount').value = fromAmount;
                return;
            }

            try {
                // Live quote estimation using 0x price endpoint
                document.getElementById('toAmount').value = 'Loading...';

                const tokenInfo = sessionTokens[fromToken];
                const decimals = tokenInfo ? tokenInfo.decimals : 18;
                const sellAmount = ethers.parseUnits(fromAmount, decimals).toString();

                const response = await fetch('/api/v3-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sellToken: fromToken,
                        buyToken: toToken,
                        sellAmount: sellAmount,
                        taker: userAddress || '0x0000000000000000000000000000000000000000'
                    })
                });

                if (response.ok) {
                    const quoteData = await response.json();
                    const toTokenInfo = sessionTokens[toToken];
                    const toDecimals = toTokenInfo ? toTokenInfo.decimals : 18;
                    const buyAmount = ethers.formatUnits(quoteData.buyAmount, toDecimals);
                    document.getElementById('toAmount').value = parseFloat(buyAmount).toFixed(6);
                } else {
                    document.getElementById('toAmount').value = '0';
                }

            } catch (error) {
                console.error('Quote error:', error);
                document.getElementById('toAmount').value = '0';
            }
        }

        // Execute multi-token swap
        async function executeSwap() {
            if (!signer || !userAddress) {
                showStatus('Please connect wallet first', 'error');
                return;
            }

            const fromToken = document.getElementById('fromTokenSelect').dataset.value || '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE';
            const toToken = document.getElementById('toTokenSelect').dataset.value || '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
            const fromAmount = document.getElementById('fromAmount').value;

            if (!fromToken || !toToken || !fromAmount) {
                showStatus('Please select tokens and enter amount', 'error');
                return;
            }

            if (fromToken === toToken) {
                showStatus('Cannot swap same token', 'error');
                return;
            }

            const btn = document.getElementById('swapBtn');
            const helper = document.getElementById('metamaskHelper');

            try {
                // Step 1: Get fresh quote for any token pair
                btn.textContent = 'Getting Quote...';
                btn.classList.add('sending');
                btn.disabled = true;
                showStatus('🔄 Getting fresh quote...', 'loading');

                const tokenInfo = sessionTokens[fromToken];
                const decimals = tokenInfo ? tokenInfo.decimals : 18;
                const sellAmount = ethers.parseUnits(fromAmount, decimals).toString();

                const response = await fetch('/api/v3-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sellToken: fromToken,
                        buyToken: toToken,
                        sellAmount: sellAmount,
                        taker: userAddress
                    })
                });

                if (!response.ok) throw new Error('Failed to get quote');

                const swapData = await response.json();
                console.log(`✅ V3 Quote: ${fromAmount} ${sessionTokens[fromToken]?.symbol} → ${ethers.formatUnits(swapData.buyAmount, sessionTokens[toToken]?.decimals || 18)} ${sessionTokens[toToken]?.symbol}`);

                // Step 2: Execute transaction
                btn.textContent = 'Sending to wallet...';
                helper.classList.add('show');
                showStatus('📱 Check MetaMask for approval...', 'loading');

                const txParams = {
                    to: swapData.to,
                    data: swapData.data,
                    value: BigInt(swapData.value || '0')
                };

                // Estimate gas
                const gasEstimate = await provider.estimateGas({
                    ...txParams,
                    from: userAddress
                });

                // Send transaction
                btn.textContent = 'Broadcasting...';
                const tx = await signer.sendTransaction({
                    ...txParams,
                    gasLimit: gasEstimate
                });

                helper.classList.remove('show');
                showStatus(`✅ Swap submitted! ${tx.hash.slice(0, 10)}...`, 'success');

                // Wait for confirmation
                btn.textContent = 'Confirming...';
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    showStatus('✅ Multi-token swap completed!', 'success');

                    // Update balances
                    await updateBalances();

                    // Reset button
                    btn.textContent = 'Swap Tokens';
                    btn.classList.remove('sending');
                    btn.disabled = false;

                    // Open explorer
                    setTimeout(() => {
                        window.open(`https://basescan.org/tx/${tx.hash}`, '_blank');
                    }, 2000);
                } else {
                    throw new Error('Transaction failed');
                }

            } catch (error) {
                console.error('Swap failed:', error.message);

                // User-friendly error handling
                if (error.message.includes('user rejected')) {
                    showStatus('❌ Transaction cancelled by user', 'warning');
                } else if (error.message.includes('insufficient funds') || error.message.includes('insufficient balance')) {
                    showStatus('❌ Insufficient balance for this swap', 'error');
                } else if (error.message.includes('transaction execution reverted') || error.message.includes('CALL_EXCEPTION')) {
                    showUserFriendlyError('Transaction failed - this happens sometimes in DeFi. Please try again!', error.message);
                } else if (error.message.includes('Failed to get quote') || error.message.includes('quote failed')) {
                    showStatus('❌ Unable to get price quote. Please try again.', 'error');
                } else {
                    // Generic friendly error for anything else
                    showUserFriendlyError('Something went wrong. Please try again!', error.message);
                }

                // Reset button
                btn.textContent = 'Swap Tokens';
                btn.classList.remove('sending');
                btn.disabled = false;
                helper.classList.remove('show');
            }
        }

        // Set default tokens
        document.getElementById('fromTokenSelect').dataset.value = '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'; // ETH
        document.getElementById('toTokenSelect').dataset.value = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // USDC
        document.getElementById('fromAmount').value = '0.005';

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    userAddress = null;
                    const btn = document.getElementById('connectBtn');
                    btn.innerHTML = '<span>🔗</span><span>Connect Base Wallet</span>';
                    btn.disabled = false;
                    document.getElementById('swapBtn').disabled = true;
                    showStatus('Wallet disconnected', 'warning');
                } else if (accounts[0] !== userAddress) {
                    connectWallet();
                }
            });
        }

        // Close modal when clicking outside
        document.getElementById('tokenModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('tokenModal')) {
                closeTokenModal();
            }
        });
    </script>
</body>
</html>